{% extends 'base.html' %}

{% block title %}Mapa de Tracking - Monitor Infantil{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>üó∫Ô∏è Mapa de Tracking en Tiempo Real</h2>
        <p class="text-muted">Visualizaci√≥n de posiciones GPS de ni√±os y √°reas seguras</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" id="btnRefresh">
            üîÑ Actualizar Mapa
        </button>
    </div>
</div>

<!-- Leyenda -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body py-2">
                <strong>Leyenda:</strong>
                <span class="ms-3">üü¢ Dentro del √°rea segura</span>
                <span class="ms-3">üî¥ Fuera del √°rea segura</span>
                <span class="ms-3">üè´ Centro educativo</span>
            </div>
        </div>
    </div>
</div>

<!-- Mapa -->
<div class="row">
    <div class="col-md-9">
        <div id="map"></div>
    </div>
    
    <!-- Sidebar con lista de ni√±os -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5>üë∂ Ni√±os Monitoreados</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="ninosList">
                    <div class="list-group-item text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        Cargando ni√±os...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Inicializar mapa centrado en Santa Cruz, Bolivia
const map = L.map('map').setView([-17.7833, -63.1812], 15);

// Agregar capa de OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Capas para organizar elementos
const capaCentros = L.layerGroup().addTo(map);
const capaPosiciones = L.layerGroup().addTo(map);

// Funci√≥n para cargar centros educativos
async function cargarCentros() {
    try {
        const response = await fetch('/api/centros/', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });
        
        if (!response.ok) {
            console.error('Error al cargar centros');
            return;
        }
        
        const data = await response.json();
        capaCentros.clearLayers();
        
        data.features.forEach(centro => {
            // Dibujar pol√≠gono del √°rea segura
            const coords = centro.geometry.coordinates[0].map(c => [c[1], c[0]]);
            const polygon = L.polygon(coords, {
                color: '#007bff',
                fillColor: '#007bff',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(capaCentros);
            
            polygon.bindPopup(`
                <strong>${centro.properties.nombre}</strong><br>
                ${centro.properties.direccion}
            `);
        });
    } catch (error) {
        console.error('Error:', error);
    }
}

// Funci√≥n para cargar posiciones de ni√±os
async function cargarPosiciones() {
    try {
        const response = await fetch('/api/ninos/', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        });
        
        if (!response.ok) {
            console.error('Error al cargar ni√±os');
            return;
        }
        
        const ninos = await response.json();
        capaPosiciones.clearLayers();
        
        let ninosHTML = '';
        
        for (const nino of ninos) {
            // Obtener √∫ltima posici√≥n
            const estadoResponse = await fetch(`/api/ninos/${nino.id}/estado/`, {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            });
            
            if (!estadoResponse.ok) continue;
            
            const estado = await estadoResponse.json();
            
            if (estado.ultima_posicion) {
                const coords = estado.ultima_posicion.geometry.coordinates;
                const lat = coords[1];
                const lng = coords[0];
                
                // Icono seg√∫n estado
                const icon = estado.dentro_area_segura 
                    ? 'üü¢' 
                    : 'üî¥';
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: `<div style="font-size: 24px;">${icon}</div>`,
                        className: 'custom-marker',
                        iconSize: [30, 30]
                    })
                }).addTo(capaPosiciones);
                
                marker.bindPopup(`
                    <strong>${nino.nombre_completo}</strong><br>
                    Estado: ${estado.dentro_area_segura ? '‚úÖ Dentro del √°rea' : '‚ö†Ô∏è Fuera del √°rea'}<br>
                    Bater√≠a: ${estado.nivel_bateria || 'N/A'}%<br>
                    <small>${estado.ultima_posicion.properties.timestamp}</small>
                `);
                
                // Agregar a lista lateral
                const estadoClass = estado.dentro_area_segura ? 'dentro-area' : 'fuera-area';
                ninosHTML += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <strong>${nino.nombre}</strong>
                            <span class="${estadoClass}">${icon}</span>
                        </div>
                        <small class="text-muted">${nino.centro_educativo.nombre}</small>
                    </div>
                `;
            }
        }
        
        document.getElementById('ninosList').innerHTML = ninosHTML || 
            '<div class="list-group-item">No hay datos disponibles</div>';
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('ninosList').innerHTML = 
            '<div class="list-group-item text-danger">Error al cargar datos</div>';
    }
}

// Bot√≥n refrescar
document.getElementById('btnRefresh').addEventListener('click', () => {
    cargarCentros();
    cargarPosiciones();
});

// Cargar datos iniciales (en modo desarrollo sin autenticaci√≥n)
// En producci√≥n, descomentar y usar JWT
cargarCentros();
cargarPosiciones();

// Auto-refresh cada 30 segundos
setInterval(() => {
    cargarPosiciones();
}, 30000);
</script>
{% endblock %}
